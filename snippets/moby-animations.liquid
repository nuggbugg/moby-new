{% comment %}
  MOBY Animations - Powered by GSAP
  - Professional scroll-triggered animations
  - Staggered reveals with easing
  - Parallax effects
  - Respects reduced motion preference
{% endcomment %}

<!-- GSAP Core + ScrollTrigger -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

<style>
  /* ========================================
     GSAP ANIMATION BASE STATES
     ======================================== */

  /* Elements waiting to animate - set by GSAP */
  [data-gsap],
  [data-gsap-fade],
  [data-gsap-slide],
  [data-gsap-scale],
  [data-gsap-stagger] > * {
    visibility: hidden;
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    [data-gsap],
    [data-gsap-fade],
    [data-gsap-slide],
    [data-gsap-scale],
    [data-gsap-stagger] > * {
      visibility: visible !important;
      opacity: 1 !important;
      transform: none !important;
    }
  }

  /* ========================================
     SECTION TRANSITION BASE STATES
     ======================================== */

  /* Section headers */
  .moby-research__header,
  .moby-stickpacks__header,
  .moby-why-moby__header,
  .moby-product-tabs__header,
  .moby-features__header,
  .moby-about-hero__content,
  .moby-partner-hero__content {
    will-change: transform, opacity;
  }

  /* Cards and grid items */
  .moby-why-moby__card,
  .moby-stickpacks__benefit,
  .moby-research__study,
  .moby-features__item,
  .moby-partner-benefit {
    will-change: transform, opacity;
  }

  /* Buy box elements */
  .moby-buy-box__gallery,
  .moby-buy-box__info {
    will-change: transform, opacity;
  }

  /* ========================================
     SMOOTH SCROLLING
     ======================================== */

  html {
    scroll-behavior: smooth;
  }

  @media (prefers-reduced-motion: reduce) {
    html {
      scroll-behavior: auto;
    }
  }

  /* ========================================
     HOVER MICRO-INTERACTIONS
     ======================================== */

  /* Button lift effect */
  .moby-cta-btn,
  .moby-buy-box__add-btn,
  .moby-research__study-link,
  .moby-partner-form__submit {
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
  }

  .moby-cta-btn:hover,
  .moby-buy-box__add-btn:hover,
  .moby-research__study-link:hover,
  .moby-partner-form__submit:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(28, 26, 16, 0.15);
  }

  /* Card hover effect */
  .moby-why-moby__card,
  .moby-stickpacks__benefit,
  .moby-features__item {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.4s ease;
  }

  .moby-why-moby__card:hover,
  .moby-stickpacks__benefit:hover,
  .moby-features__item:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(28, 26, 16, 0.1);
  }

  /* Image zoom on hover */
  .moby-buy-box__main-image img,
  .moby-featured-product__image img {
    transition: transform 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .moby-buy-box__main-image:hover img,
  .moby-featured-product__image:hover img {
    transform: scale(1.05);
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Check for reduced motion preference
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (prefersReducedMotion) {
    // Show all elements without animation
    gsap.set('[data-gsap], [data-gsap-fade], [data-gsap-slide], [data-gsap-scale], [data-gsap-stagger] > *', {
      visibility: 'visible',
      opacity: 1,
      y: 0,
      x: 0,
      scale: 1
    });
    return;
  }

  // Register ScrollTrigger
  gsap.registerPlugin(ScrollTrigger);

  // Default easing - smooth and professional
  const defaultEase = 'power3.out';
  const bounceEase = 'back.out(1.2)';
  const smoothEase = 'power2.out';

  // ========================================
  // HERO SECTION ANIMATIONS
  // ========================================

  // Buy Box - Slide in from sides
  const buyBox = document.querySelector('.moby-buy-box');
  if (buyBox) {
    const gallery = buyBox.querySelector('.moby-buy-box__gallery');
    const info = buyBox.querySelector('.moby-buy-box__info');
    const trustItems = buyBox.querySelectorAll('.moby-buy-box__trust-item');
    const trustIcons = buyBox.querySelectorAll('.moby-buy-box__trust-icon');

    if (gallery) {
      gsap.fromTo(gallery,
        { x: -60, opacity: 0, visibility: 'hidden' },
        {
          x: 0,
          opacity: 1,
          visibility: 'visible',
          duration: 1,
          ease: defaultEase,
          delay: 0.2
        }
      );
    }

    if (info) {
      gsap.fromTo(info,
        { x: 60, opacity: 0, visibility: 'hidden' },
        {
          x: 0,
          opacity: 1,
          visibility: 'visible',
          duration: 1,
          ease: defaultEase,
          delay: 0.4
        }
      );
    }

    if (trustItems.length > 0) {
      gsap.fromTo(trustItems,
        { y: 20, opacity: 0, visibility: 'hidden' },
        {
          y: 0,
          opacity: 1,
          visibility: 'visible',
          duration: 0.6,
          stagger: 0.1,
          ease: bounceEase,
          delay: 0.8
        }
      );
    }

    if (trustIcons.length > 0) {
      gsap.fromTo(trustIcons,
        { y: 30, opacity: 0, visibility: 'hidden' },
        {
          y: 0,
          opacity: 1,
          visibility: 'visible',
          duration: 0.6,
          stagger: 0.15,
          ease: bounceEase,
          delay: 1
        }
      );
    }
  }

  // ========================================
  // SECTION HEADER ANIMATIONS
  // ========================================

  const sectionHeaders = document.querySelectorAll(`
    .moby-research__header,
    .moby-stickpacks__header,
    .moby-why-moby__header,
    .moby-product-tabs__header,
    .moby-features__header,
    .moby-about-mission__header,
    .moby-about-values__header,
    .moby-partner-benefits__header
  `);

  sectionHeaders.forEach(header => {
    const badge = header.querySelector('[class*="badge"]');
    const heading = header.querySelector('[class*="heading"], h2');
    const subheading = header.querySelector('[class*="subheading"], p');

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: header,
        start: 'top 85%',
        toggleActions: 'play none none none'
      }
    });

    if (badge) {
      tl.fromTo(badge,
        { y: 20, opacity: 0 },
        { y: 0, opacity: 1, duration: 0.5, ease: defaultEase }
      );
    }

    if (heading) {
      tl.fromTo(heading,
        { y: 30, opacity: 0 },
        { y: 0, opacity: 1, duration: 0.7, ease: defaultEase },
        badge ? '-=0.3' : 0
      );
    }

    if (subheading) {
      tl.fromTo(subheading,
        { y: 20, opacity: 0 },
        { y: 0, opacity: 1, duration: 0.6, ease: defaultEase },
        '-=0.4'
      );
    }
  });

  // ========================================
  // FEATURES SECTION - Staggered grid
  // ========================================

  const featuresGrid = document.querySelector('.moby-features__grid');
  if (featuresGrid) {
    const items = featuresGrid.querySelectorAll('.moby-features__item');

    gsap.fromTo(items,
      { y: 40, opacity: 0, scale: 0.95 },
      {
        y: 0,
        opacity: 1,
        scale: 1,
        duration: 0.6,
        stagger: 0.1,
        ease: bounceEase,
        scrollTrigger: {
          trigger: featuresGrid,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // WHY STICKPACKS - Benefits cards
  // ========================================

  const stickpacksBenefits = document.querySelectorAll('.moby-stickpacks__benefit');
  if (stickpacksBenefits.length > 0) {
    gsap.fromTo(stickpacksBenefits,
      { y: 50, opacity: 0, scale: 0.9 },
      {
        y: 0,
        opacity: 1,
        scale: 1,
        duration: 0.7,
        stagger: 0.12,
        ease: bounceEase,
        scrollTrigger: {
          trigger: stickpacksBenefits[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // Comparison table
  const comparisonTable = document.querySelector('.moby-stickpacks__comparison');
  if (comparisonTable) {
    gsap.fromTo(comparisonTable,
      { y: 40, opacity: 0, scale: 0.95 },
      {
        y: 0,
        opacity: 1,
        scale: 1,
        duration: 0.8,
        ease: defaultEase,
        scrollTrigger: {
          trigger: comparisonTable,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // WHY MOBY - Cards
  // ========================================

  const whyMobyCards = document.querySelectorAll('.moby-why-moby__card');
  if (whyMobyCards.length > 0) {
    gsap.fromTo(whyMobyCards,
      { y: 60, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.8,
        stagger: 0.15,
        ease: defaultEase,
        scrollTrigger: {
          trigger: whyMobyCards[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // RESEARCH SECTION - Studies accordion
  // ========================================

  const researchStudies = document.querySelectorAll('.moby-research__study');
  if (researchStudies.length > 0) {
    gsap.fromTo(researchStudies,
      { y: 40, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.6,
        stagger: 0.1,
        ease: smoothEase,
        scrollTrigger: {
          trigger: researchStudies[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // PRODUCT TABS
  // ========================================

  const productTabsNav = document.querySelector('.moby-product-tabs__nav');
  if (productTabsNav) {
    const tabs = productTabsNav.querySelectorAll('.moby-product-tabs__tab');

    gsap.fromTo(tabs,
      { y: 20, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.5,
        stagger: 0.08,
        ease: bounceEase,
        scrollTrigger: {
          trigger: productTabsNav,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // ABOUT PAGE SECTIONS
  // ========================================

  // About Hero
  const aboutHero = document.querySelector('.moby-about-hero');
  if (aboutHero) {
    const content = aboutHero.querySelector('.moby-about-hero__content');
    const image = aboutHero.querySelector('.moby-about-hero__image');

    if (content) {
      gsap.fromTo(content,
        { y: 40, opacity: 0 },
        { y: 0, opacity: 1, duration: 1, ease: defaultEase, delay: 0.2 }
      );
    }

    if (image) {
      gsap.fromTo(image,
        { scale: 1.1, opacity: 0 },
        { scale: 1, opacity: 1, duration: 1.2, ease: smoothEase, delay: 0.1 }
      );
    }
  }

  // About Mission
  const missionCards = document.querySelectorAll('.moby-about-mission__card');
  if (missionCards.length > 0) {
    gsap.fromTo(missionCards,
      { y: 50, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.7,
        stagger: 0.12,
        ease: bounceEase,
        scrollTrigger: {
          trigger: missionCards[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // About Values
  const valueCards = document.querySelectorAll('.moby-about-values__card');
  if (valueCards.length > 0) {
    gsap.fromTo(valueCards,
      { y: 40, opacity: 0, scale: 0.95 },
      {
        y: 0,
        opacity: 1,
        scale: 1,
        duration: 0.6,
        stagger: 0.1,
        ease: bounceEase,
        scrollTrigger: {
          trigger: valueCards[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // PARTNER PAGE SECTIONS
  // ========================================

  // Partner Hero
  const partnerHero = document.querySelector('.moby-partner-hero');
  if (partnerHero) {
    const content = partnerHero.querySelector('.moby-partner-hero__content');

    if (content) {
      gsap.fromTo(content,
        { y: 50, opacity: 0 },
        { y: 0, opacity: 1, duration: 1, ease: defaultEase, delay: 0.3 }
      );
    }
  }

  // Partner Benefits
  const partnerBenefits = document.querySelectorAll('.moby-partner-benefit');
  if (partnerBenefits.length > 0) {
    gsap.fromTo(partnerBenefits,
      { y: 40, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.6,
        stagger: 0.1,
        ease: bounceEase,
        scrollTrigger: {
          trigger: partnerBenefits[0].parentElement,
          start: 'top 80%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // Partner Form
  const partnerForm = document.querySelector('.moby-partner-form__form');
  if (partnerForm) {
    gsap.fromTo(partnerForm,
      { y: 30, opacity: 0 },
      {
        y: 0,
        opacity: 1,
        duration: 0.8,
        ease: defaultEase,
        scrollTrigger: {
          trigger: partnerForm,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  }

  // ========================================
  // FEATURED PRODUCT
  // ========================================

  const featuredProduct = document.querySelector('.moby-featured-product');
  if (featuredProduct) {
    const image = featuredProduct.querySelector('.moby-featured-product__image');
    const content = featuredProduct.querySelector('.moby-featured-product__content');

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: featuredProduct,
        start: 'top 80%',
        toggleActions: 'play none none none'
      }
    });

    if (image) {
      tl.fromTo(image,
        { x: -50, opacity: 0 },
        { x: 0, opacity: 1, duration: 0.8, ease: defaultEase }
      );
    }

    if (content) {
      tl.fromTo(content,
        { x: 50, opacity: 0 },
        { x: 0, opacity: 1, duration: 0.8, ease: defaultEase },
        '-=0.5'
      );
    }
  }

  // ========================================
  // GENERIC DATA ATTRIBUTE ANIMATIONS
  // ========================================

  // Fade animations
  document.querySelectorAll('[data-gsap-fade]').forEach(el => {
    gsap.fromTo(el,
      { opacity: 0, visibility: 'hidden' },
      {
        opacity: 1,
        visibility: 'visible',
        duration: 0.8,
        ease: defaultEase,
        scrollTrigger: {
          trigger: el,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  });

  // Slide up animations
  document.querySelectorAll('[data-gsap-slide]').forEach(el => {
    const direction = el.dataset.gsapSlide || 'up';
    const from = {
      up: { y: 50 },
      down: { y: -50 },
      left: { x: 50 },
      right: { x: -50 }
    };

    gsap.fromTo(el,
      { ...from[direction], opacity: 0, visibility: 'hidden' },
      {
        x: 0,
        y: 0,
        opacity: 1,
        visibility: 'visible',
        duration: 0.8,
        ease: defaultEase,
        scrollTrigger: {
          trigger: el,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  });

  // Scale animations
  document.querySelectorAll('[data-gsap-scale]').forEach(el => {
    gsap.fromTo(el,
      { scale: 0.9, opacity: 0, visibility: 'hidden' },
      {
        scale: 1,
        opacity: 1,
        visibility: 'visible',
        duration: 0.8,
        ease: bounceEase,
        scrollTrigger: {
          trigger: el,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  });

  // Stagger container animations
  document.querySelectorAll('[data-gsap-stagger]').forEach(container => {
    const children = container.children;
    const staggerDelay = parseFloat(container.dataset.gsapStagger) || 0.1;

    gsap.fromTo(children,
      { y: 30, opacity: 0, visibility: 'hidden' },
      {
        y: 0,
        opacity: 1,
        visibility: 'visible',
        duration: 0.6,
        stagger: staggerDelay,
        ease: bounceEase,
        scrollTrigger: {
          trigger: container,
          start: 'top 85%',
          toggleActions: 'play none none none'
        }
      }
    );
  });

  // ========================================
  // PARALLAX EFFECTS
  // ========================================

  document.querySelectorAll('[data-gsap-parallax]').forEach(el => {
    const speed = parseFloat(el.dataset.gsapParallax) || 0.3;

    gsap.to(el, {
      y: () => window.innerHeight * speed * -1,
      ease: 'none',
      scrollTrigger: {
        trigger: el,
        start: 'top bottom',
        end: 'bottom top',
        scrub: true
      }
    });
  });

  // ========================================
  // REFRESH ON RESIZE
  // ========================================

  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      ScrollTrigger.refresh();
    }, 250);
  });

  // Refresh ScrollTrigger after images load
  window.addEventListener('load', () => {
    ScrollTrigger.refresh();
  });
});
</script>
