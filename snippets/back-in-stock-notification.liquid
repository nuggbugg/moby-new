{%- doc -%}
  Renders a "Notify Me" button that triggers the global newsletter popup.
  This button appears on sold out/prelaunch products.

  @param {object} product - The product object
  @param {object} variant - The specific variant (optional)
  @param {string} [class] - Additional CSS classes for the button
{%- enddoc -%}

{%- liquid
  assign current_variant = variant | default: product.selected_or_first_available_variant
  assign product_handle = product.handle
  assign product_title = product.title
-%}

<notify-button-component
  class="back-in-stock"
  data-product-handle="{{ product_handle }}"
  data-product-title="{{ product_title | escape }}"
>
  <button
    type="button"
    ref="notifyButton"
    class="button back-in-stock__button {{ class }}"
  >
    <span class="back-in-stock__icon" ref="buttonIcon">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
      </svg>
    </span>
    <span class="back-in-stock__icon back-in-stock__icon--check" ref="buttonIconCheck" style="display: none;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </span>
    <span class="back-in-stock__text" ref="buttonText">{{ 'products.product.notify_when_available' | t | default: 'Notify Me When Available' }}</span>
  </button>
</notify-button-component>

<script>
  class NotifyButtonComponent extends HTMLElement {
    constructor() {
      super();
      this.notifyButton = this.querySelector('[ref="notifyButton"]');
      this.buttonText = this.querySelector('[ref="buttonText"]');
      this.buttonIcon = this.querySelector('[ref="buttonIcon"]');
      this.buttonIconCheck = this.querySelector('[ref="buttonIconCheck"]');
      this.storageKey = 'moby-notify-signup';
      this.productHandle = this.dataset.productHandle;
      this.productTitle = this.dataset.productTitle;
    }

    connectedCallback() {
      // Check if user already signed up
      this.checkAlreadySignedUp();

      // Click triggers global newsletter popup
      this.notifyButton?.addEventListener('click', () => {
        // Push dataLayer event
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'notify_button_clicked',
          product_handle: this.productHandle,
          product_title: this.productTitle
        });

        // Dispatch event to open global newsletter popup
        document.dispatchEvent(new CustomEvent('open-newsletter-popup', {
          detail: {
            trigger: 'notify_button',
            product: this.productHandle
          }
        }));
      });
    }

    checkAlreadySignedUp() {
      try {
        const signups = JSON.parse(localStorage.getItem(this.storageKey) || '{}');
        if (signups['_global']) {
          this.setAlreadySignedUpState();
        }
      } catch (e) {}
    }

    setAlreadySignedUpState() {
      if (this.buttonText) {
        this.buttonText.textContent = "You're Already on the List!";
      }
      if (this.buttonIcon) this.buttonIcon.style.display = 'none';
      if (this.buttonIconCheck) this.buttonIconCheck.style.display = 'flex';
      this.notifyButton?.classList.add('back-in-stock__button--signed-up');
    }
  }

  if (!customElements.get('notify-button-component')) {
    customElements.define('notify-button-component', NotifyButtonComponent);
  }
</script>

{% stylesheet %}
  .back-in-stock__button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    background: var(--moby-olive, #4F4A32);
    color: #fff;
    border: none;
    transition: background 0.2s ease, transform 0.15s ease;
  }

  .back-in-stock__button:hover {
    background: var(--moby-dark, #1B1A0F);
  }

  .back-in-stock__button:active {
    transform: scale(0.98);
  }

  .back-in-stock__button--signed-up {
    background: var(--moby-sage, #C9C8B6);
    color: var(--moby-dark, #1B1A0F);
  }

  .back-in-stock__button--signed-up:hover {
    background: var(--moby-olive, #4F4A32);
    color: #fff;
  }

  .back-in-stock__icon {
    display: flex;
    align-items: center;
  }

  .back-in-stock__icon--check {
    color: var(--moby-lime, #F9FDB5);
  }

  .back-in-stock__button--signed-up .back-in-stock__icon--check {
    color: var(--moby-olive, #4F4A32);
  }
{% endstylesheet %}
