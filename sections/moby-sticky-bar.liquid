{% comment %}
  MOBY Sticky Product Bar
  - Fixed to bottom of screen
  - Shows product image, title, price, and add to cart
  - Only visible when main product form is out of viewport
{% endcomment %}

{%- assign current_variant = product.selected_or_first_available_variant -%}
{%- assign product_image = product.featured_image | default: product.images.first -%}
{%- assign variant_inventory = current_variant.inventory_quantity | default: 0 -%}
{%- assign inventory_policy = current_variant.inventory_policy | default: 'deny' -%}

<div class="moby-sticky-bar" id="moby-sticky-bar" data-hidden="true">
  <div class="moby-sticky-bar__container">
    <div class="moby-sticky-bar__content">
      <!-- Product Image -->
      {%- if product_image -%}
        <div class="moby-sticky-bar__image">
          <img
            src="{{ product_image | image_url: width: 120 }}"
            alt="{{ product.title | escape }}"
            width="56"
            height="56"
            loading="lazy"
          >
        </div>
      {%- endif -%}

      <!-- Product Info -->
      <div class="moby-sticky-bar__info">
        <p class="moby-sticky-bar__title">{{ product.title }}</p>
        <div class="moby-sticky-bar__price-wrap">
          <p class="moby-sticky-bar__price">{{ current_variant.price | money }}</p>
          {%- if current_variant.compare_at_price > current_variant.price -%}
            {%- assign savings_percent = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round -%}
            <span class="moby-sticky-bar__badge">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="5" x2="5" y2="19"></line>
                <circle cx="6.5" cy="6.5" r="2.5"></circle>
                <circle cx="17.5" cy="17.5" r="2.5"></circle>
              </svg>
              Save {{ savings_percent }}%
            </span>
          {%- endif -%}
        </div>
      </div>

      <!-- Add to Cart Button -->
      {%- if current_variant.available -%}
        <button
          type="button"
          class="moby-sticky-bar__button"
          data-sticky-add-to-cart
          data-variant-id="{{ current_variant.id }}"
          data-product-handle="{{ product.handle }}"
          data-product-id="{{ product.id }}"
          data-inventory-quantity="{{ variant_inventory }}"
          data-inventory-policy="{{ inventory_policy }}"
        >
          <span class="moby-sticky-bar__button-full">Add to Cart</span>
          <span class="moby-sticky-bar__button-short">Add</span>
        </button>
      {%- else -%}
        <button
          type="button"
          class="moby-sticky-bar__button moby-sticky-bar__button--notify"
          data-sticky-notify
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span class="moby-sticky-bar__button-full">Notify Me</span>
          <span class="moby-sticky-bar__button-short">Notify</span>
        </button>
      {%- endif -%}
    </div>
  </div>
</div>

<style>
  .moby-sticky-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #ffffff;
    border-top: 1px solid rgba(201, 200, 182, 0.3);
    box-shadow: 0 -4px 24px rgba(28, 26, 16, 0.08);
    z-index: 90;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }

  .moby-sticky-bar[data-hidden="false"] {
    transform: translateY(0);
  }

  .moby-sticky-bar__container {
    width: 90%;
    max-width: 1296px;
    margin: 0 auto;
    padding: 12px 0;
  }

  .moby-sticky-bar__content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  @media (min-width: 768px) {
    .moby-sticky-bar__content {
      gap: 16px;
    }
  }

  /* Product Image */
  .moby-sticky-bar__image {
    width: 56px;
    height: 56px;
    flex-shrink: 0;
    border-radius: 6px;
    overflow: hidden;
    background: rgba(201, 200, 182, 0.15);
  }

  .moby-sticky-bar__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Product Info */
  .moby-sticky-bar__info {
    flex: 1;
    min-width: 0;
  }

  .moby-sticky-bar__title {
    font-family: 'N27', sans-serif;
    font-size: 11px;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--moby-dark, #1C1A10);
    margin: 0 0 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.3;
  }

  @media (min-width: 768px) {
    .moby-sticky-bar__title {
      font-size: 13px;
    }
  }

  .moby-sticky-bar__price-wrap {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .moby-sticky-bar__price {
    font-family: 'Memoir', serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--moby-dark, #1C1A10);
    margin: 0;
  }

  @media (min-width: 768px) {
    .moby-sticky-bar__price {
      font-size: 18px;
    }
  }

  .moby-sticky-bar__badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-family: 'N27', sans-serif;
    font-size: 10px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    background: rgba(201, 200, 182, 0.2);
    color: var(--moby-dark, #1C1A10);
    padding: 3px 8px;
    border-radius: 4px;
  }

  .moby-sticky-bar__badge svg {
    width: 12px;
    height: 12px;
  }

  /* Button */
  .moby-sticky-bar__button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-shrink: 0;
    font-family: 'N27', sans-serif;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #ffffff;
    background: var(--moby-olive, #4F4A32);
    border: none;
    border-radius: 4px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.2s ease;
    box-shadow: 0 2px 8px rgba(79, 74, 50, 0.2);
  }

  @media (min-width: 768px) {
    .moby-sticky-bar__button {
      font-size: 13px;
      padding: 14px 20px;
    }
  }

  .moby-sticky-bar__button:hover {
    background: var(--moby-dark, #1C1A10);
  }

  .moby-sticky-bar__button--notify {
    background: var(--moby-olive, #4F4A32);
  }

  .moby-sticky-bar__button-full {
    display: none;
  }

  .moby-sticky-bar__button-short {
    display: inline;
  }

  @media (min-width: 640px) {
    .moby-sticky-bar__button-full {
      display: inline;
    }
    .moby-sticky-bar__button-short {
      display: none;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const stickyBar = document.getElementById('moby-sticky-bar');

    // Find the actual add-to-cart button (prioritize MOBY buy box, then default product forms)
    const mainAddToCart = document.querySelector(
      '.moby-buy-box__add-btn, ' +
      '#moby-buy-box-form, ' +
      '.moby-buy-box__form, ' +
      '[data-product-form] button[type="submit"], ' +
      '.product-form__submit, ' +
      'form[action*="/cart/add"] button[type="submit"]'
    );

    if (!stickyBar || !mainAddToCart) return;

    const addToCartBtn = stickyBar.querySelector('[data-sticky-add-to-cart]');
    const notifyBtn = stickyBar.querySelector('[data-sticky-notify]');

    // Function to check stock and update button state
    async function checkStockAndUpdateButton() {
      if (!addToCartBtn) return;

      const productId = addToCartBtn.dataset.productId;
      const inventoryQty = parseInt(addToCartBtn.dataset.inventoryQuantity) || 0;
      const inventoryPolicy = addToCartBtn.dataset.inventoryPolicy || 'deny';

      if (inventoryPolicy !== 'deny') return;

      try {
        const cartResponse = await fetch('/cart.js', { headers: { 'Accept': 'application/json' } });
        const cart = await cartResponse.json();

        let currentQtyInCart = 0;
        cart.items.forEach(item => {
          if (String(item.product_id) === String(productId)) {
            currentQtyInCart += item.quantity;
          }
        });

        if (currentQtyInCart >= inventoryQty) {
          // Stock exhausted - convert to Notify Me button
          addToCartBtn.classList.add('moby-sticky-bar__button--notify');
          addToCartBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="moby-sticky-bar__button-full">Notify Me</span>
            <span class="moby-sticky-bar__button-short">Notify</span>
          `;
          addToCartBtn.dataset.stockExhausted = 'true';
        } else {
          // Stock available - show Add to Cart
          addToCartBtn.classList.remove('moby-sticky-bar__button--notify');
          addToCartBtn.innerHTML = `
            <span class="moby-sticky-bar__button-full">Add to Cart</span>
            <span class="moby-sticky-bar__button-short">Add</span>
          `;
          addToCartBtn.dataset.stockExhausted = 'false';
        }
      } catch (error) {
        console.error('Stock check error:', error);
      }
    }

    // Check stock on page load
    checkStockAndUpdateButton();

    // Listen for cart updates
    document.addEventListener('cart:refresh', checkStockAndUpdateButton);

    // Intersection Observer to show/hide sticky bar
    const observer = new IntersectionObserver(
      ([entry]) => {
        const isAboveViewport = entry.boundingClientRect.bottom < 80;

        if (entry.isIntersecting) {
          stickyBar.setAttribute('data-hidden', 'true');
        } else if (isAboveViewport) {
          stickyBar.setAttribute('data-hidden', 'false');
        } else {
          stickyBar.setAttribute('data-hidden', 'true');
        }
      },
      {
        threshold: 0,
        rootMargin: '-80px 0px 0px 0px'
      }
    );

    observer.observe(mainAddToCart);

    // Handle add to cart / notify me click
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async function() {
        // If stock is exhausted, open notify modal
        if (addToCartBtn.dataset.stockExhausted === 'true') {
          const backInStockComponent = document.querySelector('back-in-stock-component');
          if (backInStockComponent && typeof backInStockComponent.openModal === 'function') {
            backInStockComponent.openModal();
          }
          return;
        }

        // Find the main buy box add-to-cart button
        const mainBuyBoxBtn = document.querySelector('.moby-buy-box__add-btn');

        if (mainBuyBoxBtn && mainBuyBoxBtn.disabled) {
          return;
        }

        // Get inventory data
        const productId = addToCartBtn.dataset.productId;
        const inventoryQty = parseInt(addToCartBtn.dataset.inventoryQuantity) || 0;
        const inventoryPolicy = addToCartBtn.dataset.inventoryPolicy || 'deny';

        if (productId && inventoryPolicy === 'deny') {
          try {
            const originalText = addToCartBtn.innerHTML;
            addToCartBtn.disabled = true;
            addToCartBtn.innerHTML = '<span>Adding...</span>';

            const cartResponse = await fetch('/cart.js', { headers: { 'Accept': 'application/json' } });
            const cart = await cartResponse.json();

            let currentQtyInCart = 0;
            cart.items.forEach(item => {
              if (String(item.product_id) === String(productId)) {
                currentQtyInCart += item.quantity;
              }
            });

            if (currentQtyInCart >= inventoryQty) {
              addToCartBtn.innerHTML = originalText;
              addToCartBtn.disabled = false;
              // Update to notify state
              await checkStockAndUpdateButton();
              return;
            }

            addToCartBtn.innerHTML = originalText;
            addToCartBtn.disabled = false;

            if (mainBuyBoxBtn && !mainBuyBoxBtn.disabled) {
              mainBuyBoxBtn.click();
            } else {
              const productForm = document.querySelector('#moby-buy-box-form, form[action*="/cart/add"]');
              if (productForm) {
                productForm.requestSubmit();
              }
            }
          } catch (error) {
            console.error('Sticky bar add to cart error:', error);
            addToCartBtn.disabled = false;
          }
        } else if (mainBuyBoxBtn && !mainBuyBoxBtn.disabled) {
          mainBuyBoxBtn.click();
        }
      });
    }

    // Handle dedicated notify me button click
    if (notifyBtn) {
      notifyBtn.addEventListener('click', function() {
        const backInStockComponent = document.querySelector('back-in-stock-component');
        if (backInStockComponent && typeof backInStockComponent.openModal === 'function') {
          backInStockComponent.openModal();
        } else {
          const notifyButton = document.querySelector('.back-in-stock__button, [ref="notifyButton"]');
          if (notifyButton) {
            notifyButton.click();
          }
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "MOBY Sticky Bar",
  "tag": "div",
  "class": "moby-sticky-bar-wrapper",
  "settings": [],
  "presets": [
    {
      "name": "MOBY Sticky Bar"
    }
  ]
}
{% endschema %}
