{% comment %}
  MOBY Featured Product Section
  - 2-column layout with product gallery and info
  - Rating stars, Klarna badge, benefits grid
  - Add to cart button with trust signals
{% endcomment %}

{%- liquid
  assign product = section.settings.product
  if product == blank
    assign product = collections['all'].products.first
  endif

  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = product.featured_image
  assign variant_inventory = current_variant.inventory_quantity | default: 0
  assign inventory_policy = current_variant.inventory_policy | default: 'deny'

  assign is_preorder = false
  if section.settings.enable_preorder
    if current_variant.inventory_quantity <= 0 and current_variant.inventory_policy == 'continue'
      assign is_preorder = true
    endif
  endif
-%}

<section class="moby-section moby-featured-product" id="moby-featured-product-{{ section.id }}">
  <div class="moby-container">
    <div class="moby-featured-product__grid">
      {%- if product != blank -%}
        <!-- Product Gallery -->
        <div class="moby-featured-product__gallery">
          <div class="moby-featured-product__main-image">
            {%- if featured_image != blank -%}
              {{ featured_image | image_url: width: 800 | image_tag:
                class: 'moby-featured-product__image',
                loading: 'lazy',
                sizes: '(min-width: 1024px) 50vw, 100vw',
                widths: '400, 600, 800, 1000',
                alt: product.title
              }}
            {%- else -%}
              {{ 'product-1' | placeholder_svg_tag: 'moby-featured-product__image moby-featured-product__placeholder' }}
            {%- endif -%}
          </div>
          
          {%- if product.images.size > 1 -%}
            <div class="moby-featured-product__thumbnails">
              {%- for image in product.images limit: 3 -%}
                <button
                  class="moby-featured-product__thumbnail{% if forloop.first %} moby-featured-product__thumbnail--active{% endif %}"
                  data-image-url="{{ image | image_url: width: 800 }}"
                  aria-label="View product image {{ forloop.index }}"
                >
                  {{ image | image_url: width: 200 | image_tag:
                    loading: 'lazy',
                    sizes: '100px',
                    widths: '100, 200',
                    alt: product.title | append: ' thumbnail'
                  }}
                </button>
              {%- endfor -%}
            </div>
          {%- endif -%}
        </div>

        <!-- Product Info -->
        <div class="moby-featured-product__info">
          <!-- Rating -->
          <div class="moby-featured-product__rating">
            {%- for i in (1..5) -%}
              <svg class="moby-featured-product__star" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L14.9 8.6L22 9.3L17 14.1L18.2 21.2L12 17.8L5.8 21.2L7 14.1L2 9.3L9.1 8.6L12 2Z"/>
              </svg>
            {%- endfor -%}
            <span class="moby-featured-product__rating-text">5-Star Rated</span>
          </div>

          <!-- Title -->
          <h2 class="moby-featured-product__title">{{ product.title }}</h2>

          {%- if is_preorder -%}
            <span class="moby-featured-product__preorder-badge">
              {{ section.settings.preorder_badge_text | default: 'Pre-order' }}
            </span>
          {%- endif -%}

          <!-- Klarna Badge -->
          {%- if section.settings.show_klarna_badge -%}
            <div class="moby-featured-product__klarna">
              {{ 'klarna' | payment_type_svg_tag: class: 'moby-featured-product__klarna-logo' }}
              <span>Pay securely with Klarna</span>
            </div>
          {%- endif -%}

          <!-- Description -->
          <div class="moby-featured-product__description">
            <p>{{ section.settings.short_description | default: product.description | strip_html | truncate: 150 }}</p>
          </div>

          <!-- Benefits Grid -->
          <div class="moby-featured-product__benefits">
            {%- for block in section.blocks -%}
              {%- if block.type == 'benefit' -%}
                <div class="moby-featured-product__benefit" {{ block.shopify_attributes }}>
                  <svg class="moby-featured-product__benefit-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    {%- case block.settings.icon -%}
                      {%- when 'zap' -%}
                        <path d="M13 2L4 14H12L11 22L20 10H12L13 2Z"/>
                      {%- when 'dumbbell' -%}
                        <path d="M6 7V17M18 7V17M2 9V15M22 9V15M6 12H18"/>
                      {%- when 'timer' -%}
                        <circle cx="12" cy="12" r="10"/><path d="M12 6V12L16 14"/>
                      {%- when 'trending' -%}
                        <path d="M23 6L13.5 15.5L8.5 10.5L1 18"/><path d="M17 6H23V12"/>
                    {%- endcase -%}
                  </svg>
                  <span>{{ block.settings.text }}</span>
                </div>
              {%- endif -%}
            {%- endfor -%}
          </div>

          <!-- Price -->
          <div class="moby-featured-product__price-wrapper">
            {%- if current_variant.compare_at_price > current_variant.price -%}
              <div class="moby-featured-product__price-display">
                <span class="moby-featured-product__price moby-featured-product__price--sale">{{ current_variant.price | money }}</span>
                <span class="moby-featured-product__price-compare">{{ current_variant.compare_at_price | money }}</span>
                {%- assign savings_percent = current_variant.compare_at_price | minus: current_variant.price | times: 100.0 | divided_by: current_variant.compare_at_price | round -%}
                <span class="moby-featured-product__price-badge">Save {{ savings_percent }}%</span>
              </div>
            {%- else -%}
              <span class="moby-featured-product__price">{{ current_variant.price | money }}</span>
            {%- endif -%}
            {%- if section.settings.subscription_link != blank -%}
              <a href="{{ section.settings.subscription_link }}" class="moby-featured-product__subscription-link">
                Subscribe & save 10%
              </a>
            {%- endif -%}
          </div>

          <!-- Buttons -->
          <div class="moby-featured-product__buttons">
            <button
              type="button"
              class="moby-featured-product__add-to-cart{% if is_preorder %} moby-featured-product__add-to-cart--preorder{% endif %}"
              data-variant-id="{{ current_variant.id }}"
              data-product-id="{{ product.id }}"
              data-product-handle="{{ product.handle }}"
              data-inventory-quantity="{{ variant_inventory }}"
              data-inventory-policy="{{ inventory_policy }}"
              data-is-preorder="{{ is_preorder }}"
              {% unless current_variant.available %}disabled{% endunless %}
            >
              {%- if is_preorder -%}
                {{ section.settings.preorder_button_text | default: 'Pre-order Now' }}
              {%- elsif current_variant.available -%}
                Add to Cart
              {%- else -%}
                Sold Out
              {%- endif -%}
            </button>

            <a href="{{ product.url }}" class="moby-featured-product__view-details">
              View Details
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </a>
          </div>

          <!-- Trust Signals -->
          <div class="moby-featured-product__trust">
            <div class="moby-featured-product__trust-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L3 7V12C3 17.5 7 21.5 12 23C17 21.5 21 17.5 21 12V7L12 2Z"/>
              </svg>
              <span>100% satisfaction guarantee</span>
            </div>
            <div class="moby-featured-product__trust-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="6" width="15" height="10" rx="1"/>
                <path d="M16 8H20L23 12V16H16V8Z"/>
                <circle cx="6" cy="18" r="2"/>
                <circle cx="19" cy="18" r="2"/>
              </svg>
              <span>Free shipping over {% render 'moby-free-shipping-threshold' %}</span>
            </div>
          </div>
        </div>
      {%- else -%}
        <p class="moby-featured-product__no-product">Select a product in section settings</p>
      {%- endif -%}
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Thumbnail gallery - scoped to this section instance
    const section = document.getElementById('moby-featured-product-{{ section.id }}');
    if (!section) return;

    const thumbnails = section.querySelectorAll('.moby-featured-product__thumbnail');
    const mainImage = section.querySelector('.moby-featured-product__main-image img');

    thumbnails.forEach(thumb => {
      thumb.addEventListener('click', function() {
        const imageUrl = this.dataset.imageUrl;
        if (mainImage && imageUrl) {
          // Update src and remove srcset to force the new image
          mainImage.src = imageUrl;
          mainImage.srcset = '';
          mainImage.removeAttribute('srcset');

          // Update active state
          thumbnails.forEach(t => t.classList.remove('moby-featured-product__thumbnail--active'));
          this.classList.add('moby-featured-product__thumbnail--active');
        }
      });
    });

    // Add to cart - with inventory validation using Liquid-provided data
    const addToCartBtn = section.querySelector('.moby-featured-product__add-to-cart');
    if (addToCartBtn) {
      const variantId = addToCartBtn.dataset.variantId;
      const productId = addToCartBtn.dataset.productId;
      const inventoryQty = parseInt(addToCartBtn.dataset.inventoryQuantity) || 0;
      const inventoryPolicy = addToCartBtn.dataset.inventoryPolicy || 'deny';
      const isPreorder = addToCartBtn.dataset.isPreorder === 'true';

      // Function to check stock and update button
      async function checkStockAndUpdateButton() {
        // Skip stock check for pre-order mode
        if (inventoryPolicy !== 'deny' || isPreorder) return;

        try {
          const cartResponse = await fetch('/cart.js', { headers: { 'Accept': 'application/json' } });
          const cart = await cartResponse.json();

          let currentQtyInCart = 0;
          cart.items.forEach(item => {
            if (String(item.product_id) === String(productId)) {
              currentQtyInCart += item.quantity;
            }
          });

          if (currentQtyInCart >= inventoryQty) {
            // Stock exhausted - show Notify Me
            addToCartBtn.classList.add('moby-featured-product__add-to-cart--notify');
            addToCartBtn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
              Notify Me
            `;
            addToCartBtn.dataset.stockExhausted = 'true';
          } else {
            // Stock available - show Add to Cart
            addToCartBtn.classList.remove('moby-featured-product__add-to-cart--notify');
            addToCartBtn.textContent = 'Add to Cart';
            addToCartBtn.dataset.stockExhausted = 'false';
          }
        } catch (error) {
          console.error('Stock check error:', error);
        }
      }

      // Check stock on page load
      checkStockAndUpdateButton();

      // Listen for cart updates
      document.addEventListener('cart:refresh', checkStockAndUpdateButton);

      addToCartBtn.addEventListener('click', async function() {
        // If stock exhausted, open notify modal
        if (this.dataset.stockExhausted === 'true') {
          const backInStockComponent = document.querySelector('back-in-stock-component');
          if (backInStockComponent && typeof backInStockComponent.openModal === 'function') {
            backInStockComponent.openModal();
          }
          return;
        }

        if (!variantId) return;

        this.disabled = true;
        this.textContent = 'Adding...';

        try {
          // Fetch cart to validate stock (skip for pre-order)
          const cartResponse = await fetch('/cart.js', { headers: { 'Accept': 'application/json' } });
          const cart = await cartResponse.json();

          if (inventoryPolicy === 'deny' && !isPreorder) {
            let currentQtyInCart = 0;
            cart.items.forEach(item => {
              if (String(item.product_id) === String(productId)) {
                currentQtyInCart += item.quantity;
              }
            });

            if (currentQtyInCart >= inventoryQty) {
              this.disabled = false;
              await checkStockAndUpdateButton();
              return;
            }
          }

          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({ id: variantId, quantity: 1 })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.description || errorData.message || 'Failed to add to cart');
          }

          this.textContent = 'Added!';

          // Update cart counter in navbar
          const cartRefreshResponse = await fetch('/cart.js');
          const cartData = await cartRefreshResponse.json();
          const cartCountElements = document.querySelectorAll('.moby-header__cart-count, [data-cart-count]');
          cartCountElements.forEach(el => {
            el.textContent = cartData.item_count;
            if (cartData.item_count > 0) {
              el.style.display = 'flex';
            }
          });

          // Open cart drawer and check stock after
          setTimeout(async () => {
            if (typeof window.openCartDrawer === 'function') {
              window.openCartDrawer();
            }
            await checkStockAndUpdateButton();
            this.disabled = false;
          }, 300);
        } catch (error) {
          console.error('Add to cart error:', error);
          const errorText = error.message && error.message.length < 30 ? error.message : 'Error - Try Again';
          this.textContent = errorText;
          setTimeout(async () => {
            await checkStockAndUpdateButton();
            this.disabled = false;
          }, 2000);
        }
      });
    }
  });
</script>

<style>
  .moby-featured-product {
    background: var(--color-background, #ffffff);
  }

  .moby-featured-product__grid {
    display: grid;
    gap: 32px;
  }

  @media (min-width: 1024px) {
    .moby-featured-product__grid {
      grid-template-columns: 1fr 1fr;
      gap: 64px;
      align-items: start;
    }
  }

  /* Gallery */
  .moby-featured-product__gallery {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .moby-featured-product__main-image {
    aspect-ratio: 1;
    background: rgba(201, 200, 182, 0.2);
    border-radius: 4px;
    overflow: hidden;
  }

  .moby-featured-product__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .moby-featured-product__placeholder {
    background: var(--moby-sage);
  }

  .moby-featured-product__thumbnails {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .moby-featured-product__thumbnail {
    aspect-ratio: 1;
    background: rgba(201, 200, 182, 0.2);
    border-radius: 4px;
    overflow: hidden;
    border: 2px solid transparent;
    cursor: pointer;
    padding: 0;
    transition: border-color 0.2s ease;
  }

  .moby-featured-product__thumbnail--active,
  .moby-featured-product__thumbnail:hover {
    border-color: var(--moby-olive, #4F4A32);
  }

  .moby-featured-product__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Info */
  .moby-featured-product__info {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .moby-featured-product__rating {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .moby-featured-product__star {
    color: var(--moby-olive, #4F4A32);
  }

  .moby-featured-product__rating-text {
    margin-left: 8px;
    font-family: 'N27', sans-serif;
    font-size: 14px;
    color: var(--moby-sage, #C9C8B6);
  }

  .moby-featured-product__title {
    font-family: 'Memoir', serif;
    font-size: 30px;
    line-height: 1.1;
    text-transform: uppercase;
    letter-spacing: -0.01em;
    margin: 0;
    color: var(--moby-dark, #1C1A10);
  }

  @media (min-width: 768px) {
    .moby-featured-product__title {
      font-size: 40px;
    }
  }

  .moby-featured-product__klarna {
    display: flex;
    align-items: center;
    gap: 12px;
    font-family: 'N27', sans-serif;
    font-size: 14px;
    color: var(--moby-sage, #C9C8B6);
  }

  .moby-featured-product__klarna-logo {
    height: 20px;
    width: auto;
  }

  .moby-featured-product__description {
    font-family: 'N27', sans-serif;
    font-size: 14px;
    font-weight: 300;
    line-height: 1.6;
    color: var(--moby-dark, #1C1A10);
  }

  .moby-featured-product__description p {
    margin: 0;
  }

  /* Benefits */
  .moby-featured-product__benefits {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .moby-featured-product__benefit {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: rgba(201, 200, 182, 0.2);
    border-radius: 4px;
  }

  .moby-featured-product__benefit-icon {
    color: var(--moby-olive, #4F4A32);
    flex-shrink: 0;
  }

  .moby-featured-product__benefit span {
    font-family: 'N27', sans-serif;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--moby-dark, #1C1A10);
  }

  /* Price */
  .moby-featured-product__price-wrapper {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .moby-featured-product__price-display {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .moby-featured-product__price {
    font-family: 'N27', sans-serif;
    font-size: 30px;
    font-weight: 700;
    color: var(--moby-dark, #1C1A10);
  }

  .moby-featured-product__price--sale {
    color: var(--moby-dark, #1C1A10);
  }

  .moby-featured-product__price-compare {
    font-family: 'N27', sans-serif;
    font-size: 18px;
    font-weight: 400;
    color: rgba(28, 26, 16, 0.5);
    text-decoration: line-through;
  }

  .moby-featured-product__price-badge {
    font-family: 'N27', sans-serif;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    padding: 6px 12px;
    background: var(--moby-olive, #4F4A32);
    color: #ffffff;
    border-radius: 4px;
  }

  .moby-featured-product__subscription-link {
    font-family: 'N27', sans-serif;
    font-size: 14px;
    color: var(--moby-olive, #4F4A32);
    text-decoration: none;
  }

  .moby-featured-product__subscription-link:hover {
    text-decoration: underline;
  }

  /* Buttons */
  .moby-featured-product__buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .moby-featured-product__add-to-cart {
    width: 100%;
    height: 48px;
    background: var(--moby-olive, #4F4A32);
    color: #ffffff;
    border: none;
    border-radius: 4px;
    font-family: 'N27', sans-serif;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .moby-featured-product__add-to-cart:hover:not(:disabled) {
    background: rgba(79, 74, 50, 0.9);
  }

  .moby-featured-product__add-to-cart:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .moby-featured-product__add-to-cart--notify {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .moby-featured-product__view-details {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    height: 48px;
    background: transparent;
    color: var(--moby-dark, #1C1A10);
    border: 1px solid var(--moby-sage, #C9C8B6);
    border-radius: 4px;
    font-family: 'N27', sans-serif;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    text-decoration: none;
    transition: border-color 0.2s ease, background 0.2s ease;
  }

  .moby-featured-product__view-details:hover {
    border-color: var(--moby-olive, #4F4A32);
    background: rgba(201, 200, 182, 0.1);
  }

  /* Trust Signals */
  .moby-featured-product__trust {
    display: flex;
    flex-wrap: wrap;
    gap: 16px 24px;
    padding-top: 8px;
  }

  .moby-featured-product__trust-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(28, 26, 16, 0.7);
  }

  .moby-featured-product__trust-item span {
    font-family: 'N27', sans-serif;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .moby-featured-product__no-product {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--moby-sage, #C9C8B6);
    font-family: 'N27', sans-serif;
  }

  /* Pre-order styles */
  .moby-featured-product__preorder-badge {
    display: inline-block;
    font-family: 'N27', sans-serif;
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background: rgba(79, 74, 50, 0.12);
    color: var(--moby-olive, #4F4A32);
    padding: 6px 12px;
    border-radius: 4px;
    margin-bottom: 16px;
  }

  .moby-featured-product__add-to-cart--preorder {
    background: var(--moby-olive, #4F4A32);
  }

  .moby-featured-product__add-to-cart--preorder:hover {
    background: var(--moby-dark, #1B1A0F);
  }
</style>

{% schema %}
{
  "name": "MOBY Featured Product",
  "tag": "section",
  "class": "moby-featured-product-wrapper",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "textarea",
      "id": "short_description",
      "label": "Short description",
      "info": "Override the product description. Leave blank to use product description."
    },
    {
      "type": "checkbox",
      "id": "show_klarna_badge",
      "label": "Show Klarna badge",
      "default": true
    },
    {
      "type": "url",
      "id": "subscription_link",
      "label": "Subscription link",
      "info": "Link to subscription option"
    },
    {
      "type": "header",
      "content": "Pre-order settings"
    },
    {
      "type": "checkbox",
      "id": "enable_preorder",
      "label": "Enable pre-order mode",
      "info": "Activates when inventory is 0 and 'Continue selling when out of stock' is enabled",
      "default": true
    },
    {
      "type": "text",
      "id": "preorder_button_text",
      "label": "Pre-order button text",
      "default": "Pre-order Now"
    },
    {
      "type": "text",
      "id": "preorder_badge_text",
      "label": "Pre-order badge text",
      "default": "Pre-order"
    }
  ],
  "blocks": [
    {
      "type": "benefit",
      "name": "Benefit",
      "settings": [
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            { "value": "zap", "label": "Lightning/Energy" },
            { "value": "dumbbell", "label": "Dumbbell/Strength" },
            { "value": "timer", "label": "Timer/Speed" },
            { "value": "trending", "label": "Trending/Recovery" }
          ],
          "default": "zap"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Benefit text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "MOBY Featured Product",
      "blocks": [
        {
          "type": "benefit",
          "settings": {
            "icon": "zap",
            "text": "Enhances energy"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "icon": "dumbbell",
            "text": "Improves strength"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "icon": "timer",
            "text": "Delays fatigue"
          }
        },
        {
          "type": "benefit",
          "settings": {
            "icon": "trending",
            "text": "Accelerates recovery"
          }
        }
      ]
    }
  ]
}
{% endschema %}
