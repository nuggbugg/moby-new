{% comment %}
  MOBY Custom Floating Header
  - Centered, not full-width
  - Shrinks on scroll
  - Semi-transparent background
{% endcomment %}

{% liquid
  assign transparent = false
  if section.settings.enable_transparent and template.name == 'index'
    assign transparent = true
  endif
%}

<moby-header
  id="moby-header"
  class="moby-header{% if transparent %} moby-header--transparent{% endif %}"
  data-transparent="{{ transparent }}"
>
  <div class="moby-header__container">
    <nav class="moby-header__nav">
      <!-- Logo -->
      <a href="{{ routes.root_url }}" class="moby-header__logo">
        {% if section.settings.logo != blank %}
          {{ section.settings.logo | image_url: width: 200 | image_tag: class: 'moby-header__logo-img', alt: shop.name }}
        {% else %}
          <span class="moby-header__logo-text">{{ shop.name }}</span>
        {% endif %}
      </a>

      <!-- Desktop Navigation -->
      <ul class="moby-header__menu">
        {% for link in section.settings.menu.links %}
          <li class="moby-header__menu-item">
            <a href="{{ link.url }}" class="moby-header__menu-link">
              {{ link.title }}
            </a>
          </li>
        {% endfor %}
      </ul>

      <!-- Right Actions -->
      <div class="moby-header__actions">
        <!-- Account (optional) -->
        {% if shop.customer_accounts_enabled %}
          <a href="{{ routes.account_url }}" class="moby-header__action moby-header__account">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="8" r="4"/>
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
            </svg>
          </a>
        {% endif %}

        <!-- Currency Selector -->
        {% if section.settings.show_currency and localization.available_countries.size > 1 %}
          <div class="moby-header__currency">
            <button type="button" class="moby-header__currency-btn" aria-expanded="false">
              <span class="moby-header__currency-symbol">{{ localization.country.currency.symbol }}</span>
              <span class="moby-header__currency-code">{{ localization.country.currency.iso_code }}</span>
              <svg class="moby-header__caret" width="10" height="6" viewBox="0 0 10 6" fill="none">
                <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
        {% endif %}

        <!-- Cart Button -->
        <a href="{{ routes.cart_url }}" class="moby-header__cart">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="6" width="18" height="15" rx="2"/>
            <path d="M8 6V5a4 4 0 118 0v1"/>
          </svg>
          <span class="moby-header__cart-text">CART</span>
          <span class="moby-header__cart-count" data-cart-count style="display: none;">
            {{ cart.item_count }}
          </span>
        </a>
      </div>

      <!-- Mobile Menu Toggle -->
      <button type="button" class="moby-header__mobile-toggle" aria-label="Menu" aria-expanded="false">
        <svg class="moby-header__hamburger" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <line x1="3" y1="6" x2="21" y2="6"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
          <line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
        <svg class="moby-header__close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display: none;">
          <line x1="6" y1="6" x2="18" y2="18"/>
          <line x1="6" y1="18" x2="18" y2="6"/>
        </svg>
      </button>
    </nav>
  </div>

  <!-- Mobile Menu Drawer -->
  <div class="moby-header__mobile-menu" hidden>
    <ul class="moby-header__mobile-links">
      {% for link in section.settings.menu.links %}
        <li>
          <a href="{{ link.url }}" class="moby-header__mobile-link">
            {{ link.title }}
          </a>
        </li>
      {% endfor %}
    </ul>
    {% if shop.customer_accounts_enabled %}
      <a href="{{ routes.account_url }}" class="moby-header__mobile-account">
        Account
      </a>
    {% endif %}
  </div>
</moby-header>

<style>
  :root {
    --moby-lime: #F9FDB5;
    --moby-olive: #4F4A32;
    --moby-sage: #C9C8B6;
    --moby-dark: #1C1A10;
    --moby-header-height: 64px;
    --moby-header-padding: 48px;
  }

  .moby-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 16px var(--moby-header-padding);
    transition: padding 0.3s ease;
  }

  .moby-header--scrolled {
    padding: 8px var(--moby-header-padding);
  }

  .moby-header__container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .moby-header__nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(79, 74, 50, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 50px;
    padding: 12px 12px 12px 24px;
    transition: all 0.3s ease;
  }

  .moby-header--scrolled .moby-header__nav {
    padding: 8px 8px 8px 20px;
    border-radius: 40px;
  }

  .moby-header--transparent:not(.moby-header--scrolled) .moby-header__nav {
    background: rgba(79, 74, 50, 0.85);
  }

  /* Logo */
  .moby-header__logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
  }

  .moby-header__logo-img {
    height: 28px;
    width: auto;
    transition: height 0.3s ease;
  }

  .moby-header--scrolled .moby-header__logo-img {
    height: 24px;
  }

  .moby-header__logo-text {
    font-size: 24px;
    font-weight: 700;
    color: var(--moby-lime);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .moby-header--scrolled .moby-header__logo-text {
    font-size: 20px;
  }

  /* Desktop Menu */
  .moby-header__menu {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 8px;
  }

  @media (min-width: 900px) {
    .moby-header__menu {
      display: flex;
    }
  }

  .moby-header__menu-link {
    display: block;
    padding: 8px 16px;
    color: var(--moby-lime);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: opacity 0.2s ease;
    white-space: nowrap;
  }

  .moby-header__menu-link:hover {
    opacity: 0.7;
  }

  /* Actions */
  .moby-header__actions {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .moby-header__action {
    display: none;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    color: var(--moby-lime);
    transition: opacity 0.2s ease;
  }

  @media (min-width: 900px) {
    .moby-header__action {
      display: flex;
    }
  }

  .moby-header__action:hover {
    opacity: 0.7;
  }

  /* Currency */
  .moby-header__currency {
    display: none;
  }

  @media (min-width: 900px) {
    .moby-header__currency {
      display: block;
    }
  }

  .moby-header__currency-btn {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    background: rgba(249, 253, 181, 0.15);
    border: none;
    border-radius: 20px;
    color: var(--moby-lime);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .moby-header__currency-btn:hover {
    background: rgba(249, 253, 181, 0.25);
  }

  .moby-header__caret {
    margin-left: 2px;
  }

  /* Cart */
  .moby-header__cart {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--moby-lime);
    border-radius: 30px;
    color: var(--moby-dark);
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.05em;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .moby-header__cart:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(249, 253, 181, 0.3);
  }

  .moby-header__cart-text {
    display: none;
  }

  @media (min-width: 900px) {
    .moby-header__cart-text {
      display: inline;
    }
  }

  /* Mobile Toggle */
  .moby-header__mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    color: var(--moby-lime);
    cursor: pointer;
    margin-left: 8px;
  }

  @media (min-width: 900px) {
    .moby-header__mobile-toggle {
      display: none;
    }
  }

  /* Mobile Menu */
  .moby-header__mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--moby-olive);
    padding: 100px 24px 24px;
    z-index: -1;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }

  .moby-header__mobile-menu[data-open="true"] {
    opacity: 1;
    visibility: visible;
  }

  .moby-header__mobile-links {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .moby-header__mobile-link {
    display: block;
    padding: 16px 0;
    color: var(--moby-lime);
    text-decoration: none;
    font-size: 24px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    border-bottom: 1px solid rgba(249, 253, 181, 0.2);
  }

  .moby-header__mobile-account {
    display: block;
    margin-top: 24px;
    padding: 16px 0;
    color: var(--moby-lime);
    text-decoration: none;
    font-size: 16px;
    opacity: 0.7;
  }

  /* Spacer for fixed header - only on non-index pages */
  body:not(:has(.moby-header--transparent)) {
    padding-top: calc(var(--moby-header-height) + 32px);
  }

  /* Fallback for browsers that don't support :has() */
  @supports not selector(:has(*)) {
    body {
      padding-top: 0;
    }
  }
</style>

<script>
  class MobyHeader extends HTMLElement {
    constructor() {
      super();
      this.lastScrollY = 0;
      this.isTransparent = this.dataset.transparent === 'true';
    }

    connectedCallback() {
      this.handleScroll = this.handleScroll.bind(this);
      this.handleMobileToggle = this.handleMobileToggle.bind(this);

      window.addEventListener('scroll', this.handleScroll, { passive: true });

      const mobileToggle = this.querySelector('.moby-header__mobile-toggle');
      if (mobileToggle) {
        mobileToggle.addEventListener('click', this.handleMobileToggle);
      }

      // Initial check
      this.handleScroll();
    }

    disconnectedCallback() {
      window.removeEventListener('scroll', this.handleScroll);
    }

    handleScroll() {
      const scrollY = window.scrollY;

      if (scrollY > 50) {
        this.classList.add('moby-header--scrolled');
      } else {
        this.classList.remove('moby-header--scrolled');
      }

      this.lastScrollY = scrollY;
    }

    handleMobileToggle() {
      const mobileMenu = this.querySelector('.moby-header__mobile-menu');
      const hamburger = this.querySelector('.moby-header__hamburger');
      const close = this.querySelector('.moby-header__close');
      const toggle = this.querySelector('.moby-header__mobile-toggle');

      const isOpen = mobileMenu.dataset.open === 'true';

      mobileMenu.dataset.open = !isOpen;
      mobileMenu.hidden = isOpen;
      toggle.setAttribute('aria-expanded', !isOpen);

      hamburger.style.display = isOpen ? 'block' : 'none';
      close.style.display = isOpen ? 'none' : 'block';

      document.body.style.overflow = isOpen ? '' : 'hidden';
    }
  }

  if (!customElements.get('moby-header')) {
    customElements.define('moby-header', MobyHeader);
  }
</script>

{% schema %}
{
  "name": "MOBY Header",
  "class": "moby-header-section",
  "settings": [
    {
      "type": "image_picker",
      "id": "logo",
      "label": "Logo"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "show_currency",
      "label": "Show currency selector",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_transparent",
      "label": "Transparent header on homepage",
      "default": true
    }
  ]
}
{% endschema %}
