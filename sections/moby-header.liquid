{% comment %}
  MOBY Custom Floating Header
  - Centered, not full-width
  - Shrinks on scroll
  - Semi-transparent background
{% endcomment %}

{% liquid
  assign transparent = false
  if section.settings.enable_transparent and template.name == 'index'
    assign transparent = true
  endif
%}

<moby-header
  id="moby-header"
  class="moby-header{% if transparent %} moby-header--transparent{% endif %}"
  data-transparent="{{ transparent }}"
>
  <div class="moby-header__container">
    <nav class="moby-header__nav">
      <!-- Logo -->
      <a href="{{ routes.root_url }}" class="moby-header__logo">
        <img
          src="https://cdn.shopify.com/s/files/1/0960/9779/6444/files/Moby_liggande_vit.svg?v=1768311349"
          alt="{{ shop.name }}"
          class="moby-header__logo-img"
          loading="eager"
        >
      </a>

      <!-- Desktop Navigation -->
      <ul class="moby-header__menu">
        {%- for link in linklists[section.settings.menu].links -%}
          <li class="moby-header__menu-item">
            <a href="{{ link.url }}" class="moby-header__menu-link{% if link.active %} moby-header__menu-link--active{% endif %}">
              {{ link.title }}
            </a>
          </li>
        {%- endfor -%}
      </ul>

      <!-- Desktop Right Actions (hidden on mobile) -->
      <div class="moby-header__actions moby-header__actions--desktop">
        <!-- Account Icon -->
        <a href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" class="moby-header__icon-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="8" r="4"/>
            <path d="M4 21c0-4.5 3.5-7 8-7s8 2.5 8 7"/>
          </svg>
        </a>

        <!-- Currency/Country Selector -->
        <div class="moby-header__localization">
          <button type="button" class="moby-header__currency-btn" aria-expanded="false" aria-controls="currency-dropdown">
            <span class="moby-header__currency-symbol">{{ localization.country.currency.symbol }}</span>
            <span class="moby-header__currency-code">{{ localization.country.currency.iso_code }}</span>
            <svg class="moby-header__caret" width="10" height="6" viewBox="0 0 10 6" fill="none">
              <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <div class="moby-header__currency-dropdown" id="currency-dropdown" hidden>
            {%- form 'localization', id: 'header-localization-form', class: 'moby-header__localization-form' -%}
              <ul class="moby-header__currency-list">
                {%- for country in localization.available_countries -%}
                  <li>
                    <button type="submit" name="country_code" value="{{ country.iso_code }}" class="moby-header__currency-option{% if country.iso_code == localization.country.iso_code %} moby-header__currency-option--active{% endif %}">
                      <span class="moby-header__currency-option-symbol">{{ country.currency.symbol }}</span>
                      <span class="moby-header__currency-option-name">{{ country.name }}</span>
                      <span class="moby-header__currency-option-code">{{ country.currency.iso_code }}</span>
                    </button>
                  </li>
                {%- endfor -%}
              </ul>
            {%- endform -%}
          </div>
        </div>

        <!-- Cart Button (Desktop) -->
        <button type="button" class="moby-header__cart" onclick="window.openCartDrawer()" aria-label="Open cart">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="7" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
            <path d="M8 7V6a4 4 0 118 0v1" stroke="currentColor" stroke-width="1.5"/>
            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="moby-header__cart-text">CART</span>
        </button>
      </div>

      <!-- Mobile Right Actions (Cart + Hamburger together) -->
      <div class="moby-header__actions moby-header__actions--mobile">
        <!-- Cart Button (Mobile) -->
        <button type="button" class="moby-header__cart" onclick="window.openCartDrawer()" aria-label="Open cart">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="4" y="7" width="16" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/>
            <path d="M8 7V6a4 4 0 118 0v1" stroke="currentColor" stroke-width="1.5"/>
            <path d="M9 12L11 14L15 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="moby-header__cart-text">CART</span>
        </button>

        <!-- Mobile Menu Toggle -->
        <button type="button" class="moby-header__mobile-toggle" aria-label="Menu" aria-expanded="false" aria-controls="mobile-menu">
          <svg class="moby-header__hamburger" width="24" height="16" viewBox="0 0 28 19" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M27.3471 16.9771C27.3471 17.5215 27.3989 18.0918 27.5545 18.7398L27.4508 18.8176C27.036 18.6361 25.74 18.5324 23.5626 18.5324H9.72044C7.54303 18.5324 6.24695 18.6361 5.8322 18.8176L5.72852 18.7398C5.88405 18.0918 5.93589 17.5215 5.93589 16.9771C5.93589 16.4328 5.88405 15.8625 5.72852 15.2145L5.8322 15.1367C6.24695 15.3182 7.54303 15.4219 9.72044 15.4219H23.5626C25.74 15.4219 27.036 15.3182 27.4508 15.1367L27.5545 15.2145C27.3989 15.8625 27.3471 16.4587 27.3471 16.9771Z" fill="var(--moby-accent)"/>
            <path d="M21.6186 9.53965C21.6186 10.084 21.6704 10.6543 21.826 11.3023L21.7223 11.3801C21.3075 11.1986 20.0114 11.0949 17.834 11.0949H3.99192C1.81451 11.0949 0.518431 11.1986 0.103686 11.3801L0 11.3023C0.155529 10.6543 0.207373 10.084 0.207373 9.53965C0.207373 8.9953 0.155529 8.42502 0 7.77698L0.103686 7.69922C0.518431 7.88067 1.81451 7.98436 3.99192 7.98436H17.834C20.0114 7.98436 21.3075 7.88067 21.7223 7.69922L21.826 7.77698C21.6704 8.42502 21.6186 9.02122 21.6186 9.53965Z" fill="var(--moby-accent)"/>
            <path d="M24.3666 1.84043C24.3666 2.38478 24.4185 2.95506 24.574 3.6031L24.4703 3.68086C24.0556 3.49941 22.7595 3.39573 20.5821 3.39573H6.73997C4.56256 3.39573 3.26648 3.49941 2.85173 3.68086L2.74805 3.6031C2.90358 2.95506 2.95542 2.38478 2.95542 1.84043C2.95542 1.29608 2.90358 0.725804 2.74805 0.0777647L2.85173 0C3.26648 0.181451 4.56256 0.285137 6.73997 0.285137H20.5821C22.7595 0.285137 24.0556 0.181451 24.4703 0L24.574 0.0777647C24.4185 0.725804 24.3666 1.322 24.3666 1.84043Z" fill="var(--moby-accent)"/>
          </svg>
          <svg class="moby-header__close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--moby-accent)" stroke-width="1.5">
            <line x1="6" y1="6" x2="18" y2="18"/>
            <line x1="6" y1="18" x2="18" y2="6"/>
          </svg>
        </button>
      </div>
    </nav>
  </div>

  <!-- Mobile Menu Dropdown -->
  <div class="moby-header__mobile-menu" id="mobile-menu" aria-hidden="true" hidden>
    <div class="moby-header__mobile-inner">
      <ul class="moby-header__mobile-links">
        {%- for link in linklists[section.settings.menu].links -%}
          <li>
            <a href="{{ link.url }}" class="moby-header__mobile-link{% if link.active %} moby-header__mobile-link--active{% endif %}">
              {{ link.title }}
            </a>
          </li>
        {%- endfor -%}
        <li>
          <a href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" class="moby-header__mobile-link">
            My Account
          </a>
        </li>
      </ul>
      <div class="moby-header__mobile-divider"></div>
      <a href="/products/moby-creatine-sticks" class="moby-header__mobile-cta">
        Shop Now
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="5" y1="12" x2="19" y2="12"/>
          <polyline points="12 5 19 12 12 19"/>
        </svg>
      </a>
    </div>
  </div>
</moby-header>

<style>
  :root {
    --moby-lime: #F9FDB5;
    --moby-olive: #4F4A32;
    --moby-sage: #C9C8B6;
    --moby-dark: #1C1A10;
    --moby-accent: #F9FDB5;
    --moby-core-contrast: #1C1A10;
    --moby-radius: 4px;
  }

  .moby-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 18px 0 0 0;
    transition: padding 300ms ease-in-out;
  }

  .moby-header__container {
    width: 90%;
    max-width: 1296px;
    margin: 0 auto;
    transition: width 300ms ease-in-out, max-width 300ms ease-in-out;
  }

  /* Scrolled state - container shrinks */
  .moby-header--scrolled .moby-header__container {
    width: 860px;
    max-width: 90%;
  }

  @media (max-width: 1024px) {
    .moby-header--scrolled .moby-header__container {
      width: 780px;
    }
  }

  @media (max-width: 768px) {
    .moby-header__container {
      width: 95%;
    }
    .moby-header--scrolled .moby-header__container {
      width: 95%;
    }
  }

  .moby-header__nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    background: rgba(27, 26, 15, 0.92);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border-radius: var(--moby-radius);
    padding: 0 8px 0 20px;
    height: 52px;
    gap: 8px;
    transition: all 300ms ease-in-out;
  }

  @media (max-width: 768px) {
    .moby-header__nav {
      padding: 0 4px 0 12px;
    }
  }

  /* Border overlay */
  .moby-header__nav::after {
    content: '';
    position: absolute;
    inset: 0;
    border: 1px solid rgba(33, 33, 33, 0.08);
    border-radius: var(--moby-radius);
    pointer-events: none;
  }

  /* Logo */
  .moby-header__logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    flex-shrink: 0;
    transition: all 300ms ease-in-out;
  }

  .moby-header__logo-img {
    height: 16px;
    width: auto;
    object-fit: contain;
    transition: height 300ms ease-in-out;
  }

  /* Desktop Menu */
  .moby-header__menu {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    gap: 32px;
    align-items: center;
  }

  @media (min-width: 1024px) {
    .moby-header__menu {
      display: flex;
    }
  }

  .moby-header__menu-item {
    margin: 0;
  }

  .moby-header__menu-link {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 11px;
    font-weight: 300;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: color 200ms ease;
    white-space: nowrap;
  }

  .moby-header__menu-link:hover,
  .moby-header__menu-link--active {
    color: #ffffff;
  }

  /* Actions */
  .moby-header__actions {
    display: flex;
    align-items: center;
    gap: 12px;
    height: 37px;
  }

  /* Desktop actions - hidden on mobile */
  .moby-header__actions--desktop {
    display: none;
  }

  @media (min-width: 1024px) {
    .moby-header__actions--desktop {
      display: flex;
    }
  }

  /* Mobile actions - hidden on desktop */
  .moby-header__actions--mobile {
    display: flex;
    gap: 8px;
  }

  @media (min-width: 1024px) {
    .moby-header__actions--mobile {
      display: none;
    }
  }

  .moby-header__icon-btn {
    display: none;
    align-items: center;
    justify-content: center;
    padding: 8px;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    transition: color 200ms ease;
  }

  @media (min-width: 1024px) {
    .moby-header__icon-btn {
      display: flex;
    }
  }

  .moby-header__icon-btn:hover {
    color: #ffffff;
  }

  .moby-header__icon-btn svg {
    width: 16px;
    height: 16px;
    stroke-width: 1.5;
  }

  /* Currency */
  .moby-header__currency-btn {
    display: none;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    background: rgba(249, 253, 181, 0.12);
    border: none;
    border-radius: var(--moby-radius);
    color: rgba(255, 255, 255, 0.8);
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 11px;
    font-weight: 300;
    letter-spacing: 0.02em;
    cursor: pointer;
    transition: background 200ms ease, color 200ms ease;
  }

  @media (min-width: 1024px) {
    .moby-header__currency-btn {
      display: flex;
    }
  }

  .moby-header__currency-btn:hover {
    background: rgba(249, 253, 181, 0.2);
    color: #ffffff;
  }

  .moby-header__caret {
    opacity: 0.8;
    transition: transform 200ms ease;
  }

  .moby-header__currency-btn[aria-expanded="true"] .moby-header__caret {
    transform: rotate(180deg);
  }

  /* Currency Dropdown */
  .moby-header__localization {
    position: relative;
  }

  .moby-header__currency-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 220px;
    max-height: 320px;
    overflow-y: auto;
    background: #1B1A0F;
    border-radius: var(--moby-radius);
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    z-index: 200;
  }

  .moby-header__currency-dropdown[hidden] {
    display: none;
  }

  .moby-header__localization-form {
    margin: 0;
  }

  .moby-header__currency-list {
    list-style: none;
    margin: 0;
    padding: 8px 0;
  }

  .moby-header__currency-list li {
    margin: 0;
  }

  .moby-header__currency-option {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 10px 16px;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.8);
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 12px;
    text-align: left;
    cursor: pointer;
    transition: background 200ms ease, color 200ms ease;
  }

  .moby-header__currency-option:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #ffffff;
  }

  .moby-header__currency-option--active {
    background: rgba(249, 253, 181, 0.12);
    color: var(--moby-lime);
  }

  .moby-header__currency-option-symbol {
    width: 20px;
    text-align: center;
    font-weight: 400;
  }

  .moby-header__currency-option-name {
    flex: 1;
    font-weight: 300;
  }

  .moby-header__currency-option-code {
    font-weight: 300;
    opacity: 0.6;
  }

  /* Cart */
  .moby-header__cart {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8.7px 16px;
    background: var(--moby-accent);
    border: none;
    border-radius: var(--moby-radius);
    color: var(--moby-core-contrast);
    text-decoration: none;
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 12px;
    font-weight: 500;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    box-shadow:
      inset 0px 0.6px 1px -0.5px rgba(255, 255, 255, 0.07),
      inset 0px 2.3px 4px -1px rgba(255, 255, 255, 0.08),
      inset 0px 10px 18px -1.5px rgba(255, 255, 255, 0.14);
    transition: opacity 200ms ease;
  }

  @media (max-width: 1024px) {
    .moby-header__cart {
      padding: 8.7px 12px;
    }
  }

  .moby-header__cart:hover {
    opacity: 0.9;
  }

  .moby-header__cart svg {
    width: 16px;
    height: 16px;
    stroke-width: 1.5;
  }

  .moby-header__cart-text {
    display: inline;
    white-space: nowrap;
  }

  /* Mobile Toggle */
  .moby-header__mobile-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background: none;
    border: none;
    cursor: pointer;
  }

  .moby-header__hamburger {
    display: block;
  }

  .moby-header__close {
    display: none;
  }

  /* Mobile Menu Dropdown */
  .moby-header__mobile-menu {
    position: absolute;
    top: 88px;
    left: 0;
    width: 100%;
    z-index: 50;
    display: none;
  }

  .moby-header__mobile-menu[data-open="true"] {
    display: block;
  }

  @media (min-width: 1024px) {
    .moby-header__mobile-menu {
      display: none !important;
    }
  }

  .moby-header__mobile-inner {
    width: 95%;
    margin: 0 auto;
    background: #1B1A0F;
    border-radius: var(--moby-radius);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .moby-header__mobile-links {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .moby-header__mobile-link {
    display: block;
    padding: 8px 0;
    color: rgba(255, 255, 255, 0.8);
    text-decoration: none;
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 14px;
    font-weight: 300;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    transition: color 200ms ease;
  }

  .moby-header__mobile-link:hover,
  .moby-header__mobile-link--active {
    color: #ffffff;
  }

  .moby-header__mobile-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.2);
    margin: 8px 0;
  }

  .moby-header__mobile-cta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: 8px;
    padding: 12px;
    background: var(--moby-accent);
    color: var(--moby-core-contrast);
    border-radius: var(--moby-radius);
    font-family: var(--font-body--family, system-ui, sans-serif);
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-decoration: none;
    transition: opacity 200ms ease;
  }

  .moby-header__mobile-cta:hover {
    opacity: 0.9;
  }

  .moby-header__mobile-cta svg {
    width: 16px;
    height: 16px;
  }

  /* Spacer for fixed header - only on non-index pages */
  body:not(:has(.moby-header--transparent)) {
    padding-top: 88px;
  }

  @supports not selector(:has(*)) {
    body {
      padding-top: 0;
    }
  }
</style>

<script>
  class MobyHeader extends HTMLElement {
    constructor() {
      super();
      this.lastScrollY = 0;
    }

    connectedCallback() {
      this.handleScroll = this.handleScroll.bind(this);
      this.handleMobileToggle = this.handleMobileToggle.bind(this);
      this.closeMobileMenu = this.closeMobileMenu.bind(this);
      this.handleCurrencyToggle = this.handleCurrencyToggle.bind(this);
      this.handleClickOutside = this.handleClickOutside.bind(this);

      window.addEventListener('scroll', this.handleScroll, { passive: true });
      document.addEventListener('click', this.handleClickOutside);

      const mobileToggle = this.querySelector('.moby-header__mobile-toggle');
      if (mobileToggle) {
        mobileToggle.addEventListener('click', this.handleMobileToggle);
      }

      // Currency dropdown toggle
      const currencyBtn = this.querySelector('.moby-header__currency-btn');
      if (currencyBtn) {
        currencyBtn.addEventListener('click', this.handleCurrencyToggle);
      }

      // Close mobile menu when clicking on links
      const mobileLinks = this.querySelectorAll('.moby-header__mobile-link, .moby-header__mobile-cta');
      mobileLinks.forEach(link => {
        link.addEventListener('click', this.closeMobileMenu);
      });

      this.handleScroll();
    }

    disconnectedCallback() {
      window.removeEventListener('scroll', this.handleScroll);
      document.removeEventListener('click', this.handleClickOutside);
    }

    handleCurrencyToggle(e) {
      e.stopPropagation();
      const btn = this.querySelector('.moby-header__currency-btn');
      const dropdown = this.querySelector('.moby-header__currency-dropdown');

      if (!btn || !dropdown) return;

      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', !isOpen);
      dropdown.hidden = isOpen;
    }

    handleClickOutside(e) {
      const localization = this.querySelector('.moby-header__localization');
      if (localization && !localization.contains(e.target)) {
        const btn = this.querySelector('.moby-header__currency-btn');
        const dropdown = this.querySelector('.moby-header__currency-dropdown');
        if (btn && dropdown) {
          btn.setAttribute('aria-expanded', 'false');
          dropdown.hidden = true;
        }
      }
    }

    handleScroll() {
      const scrollY = window.scrollY;

      // Scroll threshold: 100px as per design spec
      if (scrollY > 100) {
        this.classList.add('moby-header--scrolled');
      } else {
        this.classList.remove('moby-header--scrolled');
      }

      this.lastScrollY = scrollY;
    }

    handleMobileToggle() {
      const mobileMenu = this.querySelector('.moby-header__mobile-menu');
      const hamburger = this.querySelector('.moby-header__hamburger');
      const close = this.querySelector('.moby-header__close');
      const toggle = this.querySelector('.moby-header__mobile-toggle');

      const isOpen = mobileMenu.dataset.open === 'true';

      mobileMenu.dataset.open = !isOpen;
      mobileMenu.hidden = isOpen;
      mobileMenu.setAttribute('aria-hidden', isOpen);
      toggle.setAttribute('aria-expanded', !isOpen);
      toggle.setAttribute('aria-label', isOpen ? 'Open menu' : 'Close menu');

      hamburger.style.display = isOpen ? 'block' : 'none';
      close.style.display = isOpen ? 'none' : 'block';

      document.body.style.overflow = isOpen ? '' : 'hidden';
    }

    closeMobileMenu() {
      const mobileMenu = this.querySelector('.moby-header__mobile-menu');
      const hamburger = this.querySelector('.moby-header__hamburger');
      const close = this.querySelector('.moby-header__close');
      const toggle = this.querySelector('.moby-header__mobile-toggle');

      if (mobileMenu.dataset.open === 'true') {
        mobileMenu.dataset.open = 'false';
        mobileMenu.hidden = true;
        mobileMenu.setAttribute('aria-hidden', 'true');
        toggle.setAttribute('aria-expanded', 'false');
        toggle.setAttribute('aria-label', 'Open menu');
        hamburger.style.display = 'block';
        close.style.display = 'none';
        document.body.style.overflow = '';
      }
    }
  }

  if (!customElements.get('moby-header')) {
    customElements.define('moby-header', MobyHeader);
  }
</script>

{% schema %}
{
  "name": "MOBY Header",
  "class": "moby-header-section",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "checkbox",
      "id": "enable_transparent",
      "label": "Transparent header on homepage",
      "default": true
    }
  ]
}
{% endschema %}
